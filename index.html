<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security: Content Security Policy (CSP) to mitigate XSS attacks -->
    <!-- This policy restricts where content (scripts, styles, fonts) can be loaded from. -->
    <!-- IMPORTANT: You must replace 'YOUR_NGROK_URL_HERE' with your actual ngrok domain. -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' https://merited-blotchier-linn.ngrok-free.dev; 
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com;
                   connect-src 'self' YOUR_NGROK_URL_HERE;">

    <title>Alfred: AI Software Butler</title>
    
    <!-- Security: Subresource Integrity (SRI) to prevent malicious CDN content -->
    <!-- IMPORTANT: The 'integrity' hashes are placeholders. You should generate real ones for your specific library versions. -->
    <script src="https://cdn.tailwindcss.com" 
            xintegrity="igm5BeiBt36UU4gqwWS7imYmelpTsZlQ45FZf+XBn9MuJbn4nQr7yx1yFydocC/K" 
            crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" 
          rel="stylesheet"
          xintegrity="Yvt2jmTtQFEtXIVH1VgGfieY/D91UJNVwWdiVUirr4Gwov6BPGKdjcxOWDiaZ5wF"
          crossorigin="anonymous">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid #4a5568;
        }
        .status-item.pending { background-color: #2d3748; }
        .status-item.success { background-color: #1a3622; color: #a7f3d0; border-color: #22c55e; }
        .status-item.error { background-color: #450a0a; color: #fecaca; border-color: #ef4444; }
        .spinner {
            border: 2px solid #4a5568;
            border-top: 2px solid #d4af37; /* Gold color for spinner */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto p-4 md:p-8">
        <div class="bg-gray-900 rounded-2xl shadow-2xl shadow-black/50 p-6 md:p-10 border border-gray-700">
            
            <div class="text-center mb-8">
                <!-- Subtle thematic icon -->
                <svg class="w-12 h-12 mx-auto mb-2 text-amber-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold text-center text-white">Alfred</h1>
                <p class="text-center text-amber-200/70 mt-2">Your personal AI software butler. How may I assist you today?</p>
            </div>

            <div class="space-y-6">
                <div>
                    <label for="repo-url" class="block text-sm font-medium text-gray-400 mb-2">New (Empty) GitHub Repository URL</label>
                    <!-- Security: Basic client-side validation for the URL format -->
                    <input type="text" id="repo-url" class="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="e.g., https://github.com/user/my-new-project" pattern="https://github\.com/.+/.+" title="Please enter a valid GitHub repository URL.">
                </div>
                <div>
                    <label for="project-idea" class="block text-sm font-medium text-gray-400 mb-2">Project Request</label>
                    <textarea id="project-idea" rows="3" class="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="Sir, what shall we build today? (e.g., 'A secure personal diary web app...')"></textarea>
                </div>
                
                <div>
                    <label for="github-token" class="block text-sm font-medium text-gray-400 mb-2">
                        GitHub Personal Access Token
                        <a href="https://github.com/settings/tokens?type=beta" target="_blank" class="text-amber-400 hover:underline text-xs ml-2">(Create one)</a>
                    </label>
                    <!-- Security: autocomplete="new-password" prevents browser from saving the token -->
                    <input type="password" id="github-token" class="w-full bg-gray-800 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-amber-500 focus:outline-none" placeholder="ghp_... or ghs_..." autocomplete="new-password">
                    <p class="text-xs text-gray-500 mt-2">
                        Create a <a href="https://github.com/settings/tokens?type=beta" target="_blank" class="text-amber-400 hover:underline">Fine-grained token</a> with <span class="font-mono bg-gray-950 px-1 rounded">'Read and write'</span> access to <span class="font-mono bg-gray-950 px-1 rounded">'Contents'</span> and <span class="font-mono bg-gray-950 px-1 rounded">'Pull requests'</span> for the target repository.
                    </p>
                </div>
            </div>

            <button id="run-build-btn" class="w-full bg-amber-600 hover:bg-amber-700 text-gray-900 font-bold py-3 px-4 rounded-lg mt-8 transition-colors duration-300 flex items-center justify-center">
                <!-- Bow tie icon -->
                <svg class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.001 1.5c-5.247 0-9.5 4.253-9.5 9.5s4.253 9.5 9.5 9.5 9.5-4.253 9.5-9.5-4.253-9.5-9.5-9.5zm4.015 12.353l-2.516-2.516-1.5 1.5 4.016 4.016zm-8.03 0l-4.016-4.016 1.5-1.5 2.516 2.516zM11 9h2v6h-2z"/></svg>
                Engage Alfred
            </button>

            <div id="results-container" class="mt-8 hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">As you wish, sir. Commencing the build...</h2>
                <div id="status-list" class="space-y-3"></div>
                <div id="final-result" class="mt-6 hidden text-center">
                    <h3 class="text-lg font-semibold text-green-400">The Task is Complete.</h3>
                    <p class="text-gray-300">A pull request has been prepared for your review:</p>
                    <a id="final-repo-link" href="#" target="_blank" class="text-amber-400 hover:underline break-all"></a>
                </div>
                <div id="error-message" class="mt-6 hidden p-4 bg-red-900/50 border border-red-700 rounded-lg">
                    <h3 class="font-bold text-red-300">Apologies, sir. An issue has occurred:</h3>
                    <p id="error-details" class="text-red-400 font-mono text-sm mt-2"></p>
                </div>
            </div>
        </div>
    </div>

<script>
// --- CONFIGURATION ---
// IMPORTANT: Update this with your live ngrok URL for the CSP to work.
const NGROK_BASE_URL = "https://merited-blotchier-linn.ngrok-free.dev"; 

// --- DOM ELEMENTS ---
const runBuildBtn = document.getElementById('run-build-btn');
const repoUrlInput = document.getElementById('repo-url');
const projectIdeaInput = document.getElementById('project-idea');
const githubTokenInput = document.getElementById('github-token');
const resultsContainer = document.getElementById('results-container');
const statusList = document.getElementById('status-list');
const finalResult = document.getElementById('final-result');
const finalRepoLink = document.getElementById('final-repo-link');
const errorMessage = document.getElementById('error-message');
const errorDetails = document.getElementById('error-details');


// --- UI HELPER FUNCTIONS ---
const updateStatus = (id, text, state = 'pending', url = '') => {
    let item = document.getElementById(id);
    if (!item) {
        item = document.createElement('div');
        item.id = id;
        item.classList.add('status-item', 'pending');
        statusList.appendChild(item);
    }
    let iconHtml = (state === 'pending') ? '<div class="spinner mr-3"></div>' : (state === 'success') ? '<svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' : '<svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
    let textHtml = `<div>${text}</div>`;
    if (url) textHtml += `<a href="${url}" target="_blank" class="ml-2 text-amber-300 hover:underline">[Review]</a>`;
    item.innerHTML = `${iconHtml}${textHtml}`;
    item.className = `status-item ${state}`;
};
const showError = (message) => {
    errorDetails.textContent = message;
    errorMessage.classList.remove('hidden');
    runBuildBtn.disabled = false;
    runBuildBtn.classList.remove('opacity-50', 'cursor-not-allowed');
};


// --- MAIN WORKFLOW ---
const runFullBuild = async () => {
    const repoUrl = repoUrlInput.value.trim();
    const projectIdea = projectIdeaInput.value.trim();
    const githubToken = githubTokenInput.value.trim();

    if (!repoUrl || !projectIdea || !githubToken) {
        alert('Sir, please provide all the required information.');
        return;
    }

    resultsContainer.classList.remove('hidden');
    errorMessage.classList.add('hidden');
    finalResult.classList.add('hidden');
    statusList.innerHTML = '';
    runBuildBtn.disabled = true;
    runBuildBtn.classList.add('opacity-50', 'cursor-not-allowed');

    try {
        // --- Agent 1: Product Manager ---
        const pmId = 'pm-status';
        updateStatus(pmId, 'Product Manager: Preparing the project specifications...');
        const specResponse = await fetch(`${NGROK_BASE_URL}/create-spec`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ project_idea: projectIdea })
        });
        if (!specResponse.ok) throw new Error(`Product Manager failed: ${await specResponse.text()}`);
        const specData = await specResponse.json();
        updateStatus(pmId, `Product Manager: Specifications complete.`, 'success');

        // --- Agent 2: Tech Lead / Architect ---
        const tlId = 'tl-status';
        updateStatus(tlId, 'Tech Lead: Designing the software architecture...');
        const archResponse = await fetch(`${NGROK_BASE_URL}/design-architecture`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_spec: specData.product_spec })
        });
        if (!archResponse.ok) throw new Error(`Tech Lead failed: ${await archResponse.text()}`);
        const archData = await archResponse.json();
        updateStatus(tlId, `Tech Lead: Architecture designed with ${archData.files.length} files.`, 'success');

        // --- Agents 3 & 4: Software Engineer & QA (Loop) ---
        for (let i = 0; i < archData.files.length; i++) {
            const file_to_build = archData.files[i];
            
            // Software Engineer
            const sweId = `swe-status-${i}`;
            updateStatus(sweId, `Software Engineer: Drafting code for ${file_to_build.file_path}...`);
            const codeResponse = await fetch(`${NGROK_BASE_URL}/write-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: file_to_build.file_path, task: file_to_build.task })
            });
            if (!codeResponse.ok) throw new Error(`Software Engineer failed for ${file_to_build.file_path}: ${await codeResponse.text()}`);
            const codeData = await codeResponse.json();
            updateStatus(sweId, `Software Engineer: Draft complete for ${file_to_build.file_path}.`, 'success');
            
            // QA & Security Engineer
            const qaId = `qa-status-${i}`;
            updateStatus(qaId, `QA & Security: Reviewing draft of ${file_to_build.file_path}...`);
            const reviewResponse = await fetch(`${NGROK_BASE_URL}/review-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: file_to_build.file_path, code_to_review: codeData.code })
            });
            if (!reviewResponse.ok) throw new Error(`QA & Security failed for ${file_to_build.file_path}: ${await reviewResponse.text()}`);
            const reviewData = await reviewResponse.json();
            if (!reviewData.approved) {
                throw new Error(`QA & Security rejected ${file_to_build.file_path}: ${reviewData.feedback}`);
            }
            updateStatus(qaId, `QA & Security: Approved ${file_to_build.file_path}.`, 'success');
        }

        // --- Final Step: Create Pull Request ---
        const prId = 'pr-status';
        updateStatus(prId, 'System: Assembling the components and preparing for review...');
        const prResponse = await fetch(`${NGROK_BASE_URL}/create-pull-request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                repo_url: repoUrl, 
                github_token: githubToken,
                architecture: archData,
                project_idea: projectIdea
            })
        });
        if (!prResponse.ok) throw new Error(`PR creation failed: ${await prResponse.text()}`);
        const prData = await prResponse.json();
        updateStatus(prId, `System: The pull request is ready for your inspection.`, 'success', prData.pull_request_url);
        
        // --- Final Result ---
        finalResult.classList.remove('hidden');
        finalRepoLink.href = prData.pull_request_url;
        finalRepoLink.textContent = prData.pull_request_url;

    } catch (error) {
        console.error('Build failed:', error);
        let errorJson = {};
        try {
            // A helper to parse potential JSON error details from the backend
            const jsonString = error.message.substring(error.message.indexOf('{'));
            errorJson = JSON.parse(jsonString);
        } catch(e) {
            errorJson = { detail: error.message };
        }
        
        const pendingItem = document.querySelector('.status-item.pending');
        if (pendingItem) {
            const text = pendingItem.textContent || "An unknown step";
            updateStatus(pendingItem.id, `Error: ${text.replace('...', '')} failed...`, 'error');
        }
        showError(errorJson.detail || "An unknown error occurred.");
    } finally {
        runBuildBtn.disabled = false;
        runBuildBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }
};

runBuildBtn.addEventListener('click', runFullBuild);
</script>
</body>
</html>

